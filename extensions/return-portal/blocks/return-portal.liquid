{% comment %}
  Return Portal Block - Customer-facing return request interface
  This block allows customers to look up orders and submit return requests
{% endcomment %}

<div 
  class="return-portal"
  data-return-portal
  data-app-url="{{ shop.url }}/apps/returns-hub"
  data-shop="{{ shop.permanent_domain }}"
  style="--primary-color: {{ block.settings.primary_color }};"
>
  <h2 class="return-portal__heading">{{ block.settings.heading | default: 'Start a Return' }}</h2>
  <p class="return-portal__subheading">{{ block.settings.subheading | default: 'Enter your order information below to initiate a return.' }}</p>

  <!-- Step 1: Order Lookup -->
  <div class="return-portal__card" data-step="lookup">
    <form class="return-portal__lookup-form" data-lookup-form>
      <div class="return-portal__form-group">
        <label class="return-portal__label" for="return-order-number">
          {{ 'return_portal.order_lookup.order_number_label' | t }}
        </label>
        <input 
          type="text" 
          id="return-order-number" 
          name="orderNumber"
          class="return-portal__input" 
          placeholder="{{ 'return_portal.order_lookup.order_number_placeholder' | t }}"
          required
        >
      </div>

      <div class="return-portal__form-group">
        <label class="return-portal__label" for="return-email">
          {{ 'return_portal.order_lookup.email_label' | t }}
        </label>
        <input 
          type="email" 
          id="return-email" 
          name="email"
          class="return-portal__input" 
          placeholder="{{ 'return_portal.order_lookup.email_placeholder' | t }}"
          required
        >
      </div>

      <div class="return-portal__error return-portal__hidden" data-lookup-error>
        <span class="return-portal__error-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </span>
        <span data-error-message></span>
      </div>

      <button type="submit" class="return-portal__button" data-lookup-button>
        <span data-button-text>{{ block.settings.button_text | default: 'Find My Order' }}</span>
        <span class="return-portal__spinner return-portal__hidden" data-button-spinner></span>
      </button>
    </form>
  </div>

  <!-- Step 2: Order Items Selection (hidden by default) -->
  <div class="return-portal__card return-portal__hidden return-portal__fade-in" data-step="items">
    <div class="return-portal__order-header">
      <div>
        <h3 class="return-portal__order-title" data-order-name></h3>
        <p class="return-portal__order-date" data-order-date></p>
      </div>
      <button type="button" class="return-portal__button return-portal__button--ghost" data-back-button>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </button>
    </div>

    <p class="return-portal__items-heading">{{ 'return_portal.order_details.select_items' | t }}</p>
    
    <div data-items-container></div>

    <div class="return-portal__summary" data-summary>
      <p class="return-portal__summary-title">{{ 'return_portal.summary.title' | t }}</p>
      <p class="return-portal__summary-count" data-summary-count>0 item(s) selected</p>
    </div>

    <div class="return-portal__error return-portal__hidden" data-submit-error>
      <span class="return-portal__error-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </span>
      <span data-error-message></span>
    </div>

    <button type="button" class="return-portal__button" data-submit-button disabled>
      <span data-button-text>{{ 'return_portal.summary.submit_button' | t }}</span>
      <span class="return-portal__spinner return-portal__hidden" data-button-spinner></span>
    </button>
  </div>

  <!-- Step 3: Confirmation (hidden by default) -->
  <div class="return-portal__card return-portal__hidden return-portal__fade-in" data-step="confirmation">
    <div class="return-portal__confirmation">
      <div class="return-portal__confirmation-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
      </div>
      <h3 class="return-portal__confirmation-title">{{ 'return_portal.confirmation.title' | t }}</h3>
      <p class="return-portal__confirmation-message">{{ 'return_portal.confirmation.message' | t }}</p>
      <p class="return-portal__confirmation-id" data-return-id></p>
      
      <div class="return-portal__next-steps">
        <p class="return-portal__next-steps-title">{{ 'return_portal.confirmation.next_steps_title' | t }}</p>
        <ol class="return-portal__next-steps-list">
          {% for step in 'return_portal.confirmation.next_steps' | t %}
            <li>{{ step }}</li>
          {% endfor %}
          <li>We will review your return request within 1-2 business days.</li>
          <li>Once approved, you will receive a prepaid shipping label via email.</li>
          <li>Pack your items securely and ship them using the provided label.</li>
          <li>Your refund will be processed within 5-7 business days after we receive the items.</li>
        </ol>
      </div>

      <button type="button" class="return-portal__button return-portal__button--secondary" data-restart-button>
        {{ 'return_portal.confirmation.start_new_return' | t }}
      </button>
    </div>
  </div>

  {% if block.settings.show_return_policy %}
    <div class="return-portal__policy">
      <a href="/policies/refund-policy" class="return-portal__policy-link">
        {{ 'return_portal.policy.link_text' | t }}
      </a>
    </div>
  {% endif %}
</div>

<!-- Item Template (used by JavaScript) -->
<template data-item-template>
  <div class="return-portal__item" data-item data-line-item-id="">
    <div class="return-portal__item-checkbox">
      <input type="checkbox" data-item-checkbox>
    </div>
    <img class="return-portal__item-image" data-item-image src="" alt="">
    <div class="return-portal__item-details">
      <p class="return-portal__item-title" data-item-title></p>
      <p class="return-portal__item-variant" data-item-variant></p>
      <div class="return-portal__item-meta">
        <span data-item-quantity></span>
        <span data-item-price></span>
      </div>
      <div class="return-portal__item-fields return-portal__hidden" data-item-fields>
        <div class="return-portal__form-group">
          <label class="return-portal__label">{{ 'return_portal.order_details.select_reason' | t }}</label>
          <select class="return-portal__select" data-item-reason required>
            <option value="">{{ 'return_portal.order_details.select_reason' | t }}</option>
            <option value="defective">{{ 'return_portal.reasons.defective' | t }}</option>
            <option value="wrong_item">{{ 'return_portal.reasons.wrong_item' | t }}</option>
            <option value="not_as_described">{{ 'return_portal.reasons.not_as_described' | t }}</option>
            <option value="no_longer_needed">{{ 'return_portal.reasons.no_longer_needed' | t }}</option>
            <option value="wrong_size">{{ 'return_portal.reasons.wrong_size' | t }}</option>
            <option value="wrong_color">{{ 'return_portal.reasons.wrong_color' | t }}</option>
            <option value="better_price">{{ 'return_portal.reasons.better_price' | t }}</option>
            <option value="other">{{ 'return_portal.reasons.other' | t }}</option>
          </select>
        </div>
        <div class="return-portal__form-group">
          <label class="return-portal__label">{{ 'return_portal.order_details.add_notes' | t }}</label>
          <textarea 
            class="return-portal__textarea" 
            data-item-notes
            placeholder="{{ 'return_portal.order_details.notes_placeholder' | t }}"
            rows="2"
          ></textarea>
        </div>
      </div>
    </div>
  </div>
</template>

{{ 'return-portal.css' | asset_url | stylesheet_tag }}
<script src="{{ 'return-portal.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Return Portal",
  "target": "section",
  "enabled_on": {
    "templates": ["page", "index"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Start a Return"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Enter your order information below to initiate a return."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Find My Order"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#000000"
    },
    {
      "type": "checkbox",
      "id": "show_return_policy",
      "label": "Show Return Policy Link",
      "default": true
    }
  ]
}
{% endschema %}
